<div
  style=" width:calc(100% + 53px); display:flex; align-items:center; justify-content:center; flex-direction:row;"
>
  <input
    type="text"
    id="game-search-online"
    placeholder="ï€‚   Search for any Wii title..."
    style="font-family:system-ui, FontAwesome"
  />
  <input type="checkbox" id="onlineOnly" style="display: none;" />
  <label
    for="onlineOnly"
    style="right:0; transform:translate(-45px, 0); z-index:100000000; position:relative;"
  >
    <i class="fa-solid fa-earth-americas"></i>
  </label>
</div>
<div id="suggestions-online"></div>

<script is:inline>
  var gameSearchInput = document.getElementById("game-search-online");
  var suggestionsDiv = document.getElementById("suggestions-online");
  var onlineFilterButton = document.getElementById("onlineOnly");

  document.getElementById("onlineOnly").addEventListener("change", function () {
    var icon = document.querySelector("#onlineOnly + label i");
    if (this.checked) {
      icon.className = "fa-solid fa-check-circle";
      fetchQuery();
      setTimeout(function () {
        suggestionsDiv.style.visibility = "visible";
        suggestionsDiv.style.maxHeight = "618px";
        suggestionsDiv.style.overflowY = "scroll";
        gameSearchInput.focus();
      }, 500);
      setTimeout(function () {
        icon.className = "fa-solid fa-earth-americas";
      }, 500);
    } else {
      icon.className = "fa-solid fa-circle-xmark";
      fetchQuery();
      setTimeout(function () {
        suggestionsDiv.style.visibility = "visible";
        suggestionsDiv.style.maxHeight = "618px";
        suggestionsDiv.style.overflowY = "scroll";
        gameSearchInput.focus();
      }, 500);
      setTimeout(function () {
        icon.className = "fa-solid fa-earth-americas";
      }, 500);
    }
  });

  gameSearchInput.addEventListener("focus", function (e) {
    suggestionsDiv.style.visibility = "visible";
    suggestionsDiv.style.maxHeight = "618px";
    setTimeout(function () {
      suggestionsDiv.style.overflowY = "scroll";
    }, 200);
  });

  gameSearchInput.addEventListener("blur", function (e) {
    setTimeout(function () {
      if (suggestionsDiv.contains(document.activeElement)) {
        return;
      }
      suggestionsDiv.style.maxHeight = "0px";
      suggestionsDiv.style.overflowY = "hidden";
      setTimeout(function () {
        suggestionsDiv.style.visibility = "hidden";
      }, 200);
    }, 0);
  });

  gameSearchInput.addEventListener("input", function (e) {
    fetchQuery();
  });

  gameSearchInput.addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      const firstSuggestion = document.querySelector("#suggestionitem");
      if (firstSuggestion) {
        window.location.href = firstSuggestion.getAttribute("href");
      }
    }
  });

  function fetchQuery() {
    fetch("../../json/gamespy_titles.json")
      .then((response) => response.json())
      .then((gamespyTitles) => {
        fetch("../../json/pages.json")
          .then((response) => response.json())
          .then((games) => {
            var gameSearchInput = document.getElementById("game-search-online");
            var suggestionsDiv = document.getElementById("suggestions-online");
            suggestionsDiv.innerHTML =
              '<p style="margin-left:20px; font-family:Gilroy; font-size:20px; transform:translate(0, 5px); color:white;">Suggestions:</p>'; // clear previous suggestions
            var inputText = gameSearchInput.value.toLowerCase();
            var onlineOnly = document.getElementById("onlineOnly").checked;
            var counter = 0;
            for (var i = 0; i < games.length; i++) {
              const gameIdPrefix = games[i].gameId.substring(0, 3);
              const isFound =
                gamespyTitles.some(
                  (gamespyTitle) => gamespyTitle.GameID === gameIdPrefix,
                ) || games[i].gamespyId;
              if (
                games[i].gameName.toLowerCase().startsWith(inputText) &&
                (!onlineOnly || isFound)
              ) {
                var discImage = "";
                if (games[i].gamespyId) {
                  discImage = games[i].gamespyId;
                } else {
                  discImage = games[i].gameId;
                }
                var onlineFeatures = "";
                var gamespyId = "";
                if (games[i].gamespyId) {
                  gamespyId = " | " + games[i].gamespyId;
                }
                var suggestion = document.createElement("div");
                if (isFound) {
                  onlineFeatures +=
                    '<i class="fa-solid fa-earth-americas" style=" padding:5px; padding-left:10px; padding-right:10px; background-color:#3c86c7; border-radius:4px; font-size:15px; margin-right:18px;"></i>';
                }

                function loadCoverImage(title) {
                  switch (title.charAt(3)) {
                    case "E":
                      return (
                        "https://art.gametdb.com/wii/cover/US/" + title + ".png"
                      );
                    case "P":
                    case "D":
                    case "H":
                    case "X":
                    case "Y":
                    case "F":
                      return (
                        "https://art.gametdb.com/wii/cover/EN/" + title + ".png"
                      );
                    case "J":
                      return (
                        "https://art.gametdb.com/wii/cover/JA/" + title + ".png"
                      );
                    case "K":
                      return (
                        "https://art.gametdb.com/wii/cover/KO/" + title + ".png"
                      );
                    default:
                      return "/img/disc_placeholder.png";
                  }
                }

                function loadDiscImage(title) {
                  switch (title.charAt(3)) {
                    case "E":
                      return (
                        "https://art.gametdb.com/wii/disc/US/" + title + ".png"
                      );
                    case "P":
                    case "D":
                    case "H":
                    case "X":
                    case "Y":
                    case "F":
                      return (
                        "https://art.gametdb.com/wii/disc/EN/" + title + ".png"
                      );
                    case "J":
                      return (
                        "https://art.gametdb.com/wii/disc/JA/" + title + ".png"
                      );
                    case "K":
                      return (
                        "https://art.gametdb.com/wii/disc/KO/" + title + ".png"
                      );
                    default:
                      return "/img/disc_placeholder.png";
                  }
                }

                suggestion.innerHTML =
                  '<a href="/online/' +
                  games[i].gameId +
                  '" id="suggestionitem" style="width:95%; height:100px; margin:10px; border-radius:8px; color:white; text-decoration:none; display:flex; align-items:center; justify-content:space-between; flex-direction:row; overflow:hidden; position:relative;"><img src="' +
                  loadCoverImage(discImage) +
                  '" onerror="this.onerror=null; this.src=\'/img/disc_placeholder.png\';" style="filter:blur(8px) opacity(0.1); position:absolute;" width="100%"><img src="' +
                  loadDiscImage(discImage) +
                  '" onerror="this.onerror=null; this.src=\'/img/disc_placeholder.png\';" style="margin-left:20px; margin-right:15px;" width="70px"><div style="width:300px; margin-right:20px; font-size:30px; white-space:nowrap; text-overflow:ellipsis; line-height:30px; text-align:right; overflow:hidden;">' +
                  games[i].gameName +
                  "<br><i>" +
                  onlineFeatures +
                  '</i><i style="font-size:20px; opacity:0.7;">' +
                  games[i].gameId +
                  "" +
                  gamespyId +
                  "</i></div></a>";
                suggestionsDiv.appendChild(suggestion);
                counter++;
              }
              if (counter >= 5) {
                break;
              }
            }
            if (counter === 0) {
              suggestionsDiv.innerHTML =
                "<center style='margin-top:18px; font-size:48px; color:white;'><i class='fa fa-heart-broken'></i><br><p style='font-size:28px;'>No results found</p></center>";
            }
          });
      });
  }
</script>

<style>
  #onlineOnly:checked + label {
    background-color: #3c86c7;
    opacity: 1;
    transition: 0.3s;
  }
  label {
    display: inline-block;
    padding: 5px 10px;
    cursor: pointer;
    color: white;
    border-radius: 4px;
    font-size: 15px;
    margin-right: 18px;
    background-color: #ffffff00;
    opacity: 0.5;
    transition: 0.3s;
  }
  label:hover {
    opacity: 1;
    transition: 0.3s;
  }
  #game-search-online {
    width: 100%;
    height: 50px;
    padding: 10px;
    border-radius: 8px;
    color: white;
    border: 2px solid #ffffff10;
    background-color: rgba(23, 23, 23, 0.965);
    -webkit-backdrop-filter: blur(8px);
    backdrop-filter: blur(8px);
    z-index: 100;
    position: relative;
  }
  #suggestions-online {
    max-height: 0px;
    width: 100%;
    transform: translate(0, -8px);
    resize: vertical;
    padding-top: 5px;
    background-color: rgba(23, 23, 23, 0.965);
    -webkit-backdrop-filter: blur(8px);
    backdrop-filter: blur(8px);
    border-radius: 8px;
    border-top-left-radius: 0px;
    border-top-right-radius: 0px;
    border: 2px solid #ffffff10;
    border-top: 0px;
    z-index: 10000;
    visibility: hidden;
    overflow-y: hidden;
    position: absolute;
    transition: 0.2s;
  }
</style>
